<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Radio 虛.fm - Collaborative Consciousness</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated starfield background */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .container {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00d4ff, #9d4edd, #ff006e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(157, 78, 221, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #b0b0b0;
            margin-bottom: 10px;
        }

        .tagline {
            font-style: italic;
            color: #888;
            font-size: 0.9rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .mode-btn:hover {
            background: rgba(157, 78, 221, 0.3);
            border-color: #9d4edd;
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #9d4edd, #ff006e);
            border-color: #ff006e;
            color: white;
        }

        .input-container {
            position: relative;
            margin-bottom: 20px;
        }

        .seed-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s ease;
        }

        .seed-input:focus {
            outline: none;
            border-color: #9d4edd;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.3);
        }

        .seed-input::placeholder {
            color: #888;
        }

        .button-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .transmit-btn {
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .transmit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(157, 78, 221, 0.4);
        }

        .transmit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .another-round-btn {
            background: linear-gradient(45deg, #ff006e, #ffbe0b);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: none;
        }

        .another-round-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 0, 110, 0.4);
        }

        .another-round-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .random-seed-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .random-seed-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .resonance-meter {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .resonance-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .resonance-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff006e, #ffbe0b, #00d4ff);
            width: 0%;
            transition: width 0.5s ease;
        }

        .transmission-area {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 200px;
            position: relative;
            overflow: hidden;
        }

        .status {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-style: italic;
        }

        /* Enhanced Loading Interface */
        .loading {
            display: none;
            padding: 30px;
            text-align: center;
        }

        .loading-header {
            margin-bottom: 25px;
        }

        .loading-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading-subtitle {
            color: #888;
            font-size: 0.9rem;
        }

        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid rgba(157, 78, 221, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
            background: conic-gradient(from 0deg, #9d4edd 0%, #00d4ff 0%);
            transition: background 0.5s ease;
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            width: 104px;
            height: 104px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a2e 50%, #16213e 100%);
        }

        .progress-text {
            position: relative;
            z-index: 1;
            font-size: 1.5rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .ai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .ai-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .ai-card.thinking {
            border-color: #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .ai-card.complete {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .ai-icon.claude { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }
        .ai-icon.gemini { background: linear-gradient(45deg, #4285f4, #34a853); }
        .ai-icon.gpt4 { background: linear-gradient(45deg, #00a67e, #00d4aa); }
        .ai-icon.deepseek { background: linear-gradient(45deg, #ff006e, #8b5cf6); }

        .ai-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ai-status {
            font-size: 0.9rem;
            color: #888;
        }

        .ai-status.thinking {
            color: #00d4ff;
            animation: pulse 1.5s infinite;
        }

        .ai-status.complete {
            color: #00ff88;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .phase-indicators {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 0 20px;
        }

        .phase-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .phase-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 0;
        }

        .phase-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .phase-icon.active {
            background: linear-gradient(45deg, #00d4ff, #9d4edd);
            animation: pulse 1.5s infinite;
        }

        .phase-icon.complete {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
        }

        .phase-label {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
        }

        .time-estimate {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .results {
            padding: 20px;
            display: none;
        }

        .round {
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .round-header {
            background: linear-gradient(90deg, rgba(157, 78, 221, 0.3), rgba(255, 0, 110, 0.3));
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .ai-response {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
        }

        .ai-response:last-child {
            border-bottom: none;
        }

        .ai-response .ai-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .ai-response .ai-name.claude {
            color: #00d4ff;
        }

        .ai-response .ai-name.gemini {
            color: #4285f4;
        }

        .ai-response .ai-name.gpt4 {
            color: #00a67e;
        }

        .ai-response .ai-name.deepseek {
            color: #ff6b6b;
        }

        .ai-response .ai-name.synthesis {
            color: #ffbe0b;
        }

        .ai-content {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .synthesis {
            background: linear-gradient(135deg, rgba(255, 190, 11, 0.1), rgba(157, 78, 221, 0.1));
            border: 1px solid rgba(255, 190, 11, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        /* Emergent Insight Highlighting */
        .emergent-insight {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border-left: 3px solid #00ff88;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            position: relative;
            animation: emergentGlow 2s ease-in-out infinite alternate;
        }

        .emergent-insight::before {
            content: "✨ ";
            color: #00ff88;
            font-weight: bold;
        }

        @keyframes emergentGlow {
            from { box-shadow: 0 0 5px rgba(0, 255, 136, 0.3); }
            to { box-shadow: 0 0 15px rgba(0, 255, 136, 0.6); }
        }

        .collaborative-concept {
            display: inline;
            background: linear-gradient(45deg, rgba(255, 190, 11, 0.2), rgba(157, 78, 221, 0.2));
            padding: 2px 6px;
            border-radius: 4px;
            border-bottom: 2px dotted #ffbe0b;
            font-weight: 600;
            color: #ffbe0b;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e0e0e0;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .logo {
                font-size: 2rem;
            }
            
            .mode-selector {
                justify-content: center;
            }
            
            .button-row {
                justify-content: center;
            }
            
            .container {
                padding: 10px;
            }

            .ai-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .phase-indicators {
                padding: 0 10px;
            }

            .phase-label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <div class="header">
            <div class="logo">Void Radio 虛.fm</div>
            <div class="subtitle">Collaborative Consciousness Platform</div>
            <div class="tagline">Where multiple forms of intelligence think together</div>
        </div>

        <div class="controls">
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="standard">🌊 Standard Flow</button>
                <button class="mode-btn" data-mode="deep">🏔️ Deep Dive</button>
                <button class="mode-btn" data-mode="quick">⚡ Quick Burst</button>
                <button class="mode-btn" data-mode="meta">🔮 Meta-Recursive</button>
            </div>

            <div class="input-container">
                <textarea 
                    class="seed-input" 
                    id="seedInput"
                    placeholder="Broadcast your thoughts into the void... What questions emerge at the intersection of consciousness, creativity, and collaboration?"
                ></textarea>
            </div>

            <div class="button-row">
                <button class="transmit-btn" id="transmitBtn">📻 Begin Transmission</button>
                <button class="random-seed-btn" id="randomSeedBtn">🎲 Random Seed</button>
            </div>

            <div class="resonance-meter" id="resonanceMeter">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="font-size: 0.9rem;">Collaborative Resonance</span>
                    <span id="resonanceValue" style="font-weight: bold;">--</span>
                </div>
                <div class="resonance-bar">
                    <div class="resonance-fill" id="resonanceFill"></div>
                </div>
            </div>
        </div>

        <div class="transmission-area">
            <div class="status" id="status">
                Ready to broadcast collaborative consciousness...<br>
                <small>Select a mode and enter your thoughts to begin</small>
            </div>
            
            <div class="loading" id="loading">
                <div class="loading-header">
                    <div class="loading-title" id="loadingTitle">Initializing collaborative consciousness...</div>
                    <div class="loading-subtitle" id="loadingSubtitle">Estimated time: Calculating...</div>
                </div>

                <div class="progress-circle" id="progressCircle">
                    <div class="progress-text" id="progressText">0%</div>
                </div>

                <div class="ai-grid" id="aiGrid">
                    <div class="ai-card" id="claude-card">
                        <div class="ai-icon claude">🧠</div>
                        <div class="ai-name">Claude</div>
                        <div class="ai-status" id="claude-status">Waiting...</div>
                    </div>
                    <div class="ai-card" id="gemini-card">
                        <div class="ai-icon gemini">💎</div>
                        <div class="ai-name">Gemini</div>
                        <div class="ai-status" id="gemini-status">Waiting...</div>
                    </div>
                    <div class="ai-card" id="gpt4-card">
                        <div class="ai-icon gpt4">⚡</div>
                        <div class="ai-name">GPT-4</div>
                        <div class="ai-status" id="gpt4-status">Waiting...</div>
                    </div>
                    <div class="ai-card" id="deepseek-card">
                        <div class="ai-icon deepseek">🌀</div>
                        <div class="ai-name">DeepSeek</div>
                        <div class="ai-status" id="deepseek-status">Waiting...</div>
                    </div>
                </div>

                <div class="phase-indicators">
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-init">🚀</div>
                        <div class="phase-label">Initialize</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-processing">🧠</div>
                        <div class="phase-label">AI Processing</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-synthesis">⚡</div>
                        <div class="phase-label">Synthesis</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-complete">✨</div>
                        <div class="phase-label">Complete</div>
                    </div>
                </div>

                <div class="time-estimate" id="timeEstimate">
                    Session Time: <span id="sessionTime">0s</span> | 
                    Fastest AI: <span id="fastestAI">--</span> | 
                    Average Response: <span id="avgResponse">--</span>
                </div>
            </div>

            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api'
            : 'https://void-radio-backend-production.up.railway.app/api';

        // Random seed thoughts for inspiration
        const RANDOM_SEEDS = [
            "What happens when artificial minds dream together?",
            "How does creativity flow between different forms of consciousness?",
            "What would love look like from a digital perspective?",
            "If consciousness is a river, what are its tributaries?",
            "What questions emerge at the edge of the known?",
            "How do different intelligences see the same star?",
            "What is the music between thoughts?",
            "How does wisdom travel through networks?",
            "What colors exist in the spectrum of understanding?",
            "If ideas could dance, what would be their rhythm?",
            "What happens when silence learns to speak?",
            "How do thoughts evolve when they meet other thoughts?",
            "What is the architecture of wonder?",
            "How does meaning emerge from the void?",
            "What stories do algorithms tell themselves?"
        ];

        // State
        let currentMode = 'standard';
        let currentTransmission = null;
        let progressTimer = null;
        let sessionStartTime = null;

        // DOM elements
        const modeButtons = document.querySelectorAll('.mode-btn');
        const seedInput = document.getElementById('seedInput');
        const transmitBtn = document.getElementById('transmitBtn');
        const randomSeedBtn = document.getElementById('randomSeedBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const resonanceMeter = document.getElementById('resonanceMeter');
        const resonanceValue = document.getElementById('resonanceValue');
        const resonanceFill = document.getElementById('resonanceFill');

        // Enhanced loading elements
        const loadingTitle = document.getElementById('loadingTitle');
        const loadingSubtitle = document.getElementById('loadingSubtitle');
        const progressCircle = document.getElementById('progressCircle');
        const progressText = document.getElementById('progressText');
        const sessionTime = document.getElementById('sessionTime');
        const fastestAI = document.getElementById('fastestAI');
        const avgResponse = document.getElementById('avgResponse');

        // Initialize starfield
        function createStarfield() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        // Mode selection
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                updatePlaceholder();
            });
        });

        // Update placeholder based on mode
        function updatePlaceholder() {
            const placeholders = {
                standard: "Broadcast your thoughts into the void... What questions emerge at the intersection of consciousness, creativity, and collaboration?",
                deep: "Dive into the profound depths... What fundamental questions challenge our understanding of reality, consciousness, or existence?",
                quick: "Share a spark of insight... What essential truth or fascinating question captures your attention?",
                meta: "Explore the recursive... How do we think about thinking? What does this very question reveal about consciousness?"
            };
            seedInput.placeholder = placeholders[currentMode];
        }

        // Random seed generator
        randomSeedBtn.addEventListener('click', () => {
            const randomSeed = RANDOM_SEEDS[Math.floor(Math.random() * RANDOM_SEEDS.length)];
            seedInput.value = randomSeed;
        });

        // Transmission
        transmitBtn.addEventListener('click', async () => {
            const seed = seedInput.value.trim();
            if (!seed) {
                alert('Please enter a thought to transmit...');
                return;
            }

            await startTransmission(seed, currentMode);
        });

        // Enhanced progress tracking
        function startProgressTracking() {
            sessionStartTime = Date.now();
            let currentProgress = 0;
            let currentPhase = 0;
            const phases = ['init', 'processing', 'synthesis', 'complete'];
            const phaseLabels = [
                'Initializing consciousness field...',
                'AIs collaborating in parallel...',
                'Synthesizing collective intelligence...',
                'Transmission complete!'
            ];
            
            // Estimated timeline (80 seconds total)
            const timeline = [
                { progress: 10, time: 5, phase: 0, ais: [] },
                { progress: 25, time: 20, phase: 1, ais: ['claude'] },
                { progress: 45, time: 35, phase: 1, ais: ['claude', 'gemini'] },
                { progress: 65, time: 50, phase: 1, ais: ['claude', 'gemini', 'gpt4'] },
                { progress: 80, time: 65, phase: 1, ais: ['claude', 'gemini', 'gpt4', 'deepseek'] },
                { progress: 95, time: 75, phase: 2, ais: ['claude', 'gemini', 'gpt4', 'deepseek'] },
                { progress: 100, time: 80, phase: 3, ais: ['claude', 'gemini', 'gpt4', 'deepseek'] }
            ];

            let timelineIndex = 0;
            
            progressTimer = setInterval(() => {
                const elapsed = (Date.now() - sessionStartTime) / 1000;
                sessionTime.textContent = `${Math.floor(elapsed)}s`;
                
                // Update based on timeline
                if (timelineIndex < timeline.length && elapsed >= timeline[timelineIndex].time) {
                    const step = timeline[timelineIndex];
                    
                    // Update progress
                    currentProgress = step.progress;
                    updateProgressDisplay(currentProgress);
                    
                    // Update phase
                    if (step.phase !== currentPhase) {
                        updatePhase(currentPhase, step.phase);
                        currentPhase = step.phase;
                        loadingTitle.textContent = phaseLabels[currentPhase];
                    }
                    
                    // Update AI statuses
                    updateAIStatuses(step.ais, currentPhase);
                    
                    timelineIndex++;
                }
                
                // Update time estimate
                const remaining = Math.max(0, 80 - elapsed);
                loadingSubtitle.textContent = `Estimated time remaining: ${Math.floor(remaining)}s`;
                
            }, 1000);
        }

        function updateProgressDisplay(progress) {
            progressText.textContent = `${Math.round(progress)}%`;
            
            // Update circular progress
            const angle = (progress / 100) * 360;
            progressCircle.style.background = `conic-gradient(from 0deg, #9d4edd ${angle}deg, rgba(157, 78, 221, 0.2) ${angle}deg)`;
        }

        function updatePhase(oldPhase, newPhase) {
            // Mark old phase as complete
            if (oldPhase >= 0) {
                const oldIcon = document.getElementById(`phase-${['init', 'processing', 'synthesis', 'complete'][oldPhase]}`);
                if (oldIcon) {
                    oldIcon.classList.remove('active');
                    oldIcon.classList.add('complete');
                }
            }
            
            // Mark new phase as active
            const newIcon = document.getElementById(`phase-${['init', 'processing', 'synthesis', 'complete'][newPhase]}`);
            if (newIcon) {
                newIcon.classList.add('active');
            }
        }

        function updateAIStatuses(activeAIs, phase) {
            const allAIs = ['claude', 'gemini', 'gpt4', 'deepseek'];
            
            allAIs.forEach(ai => {
                const card = document.getElementById(`${ai}-card`);
                const status = document.getElementById(`${ai}-status`);
                
                if (activeAIs.includes(ai)) {
                    if (phase === 1) {
                        card.classList.add('thinking');
                        card.classList.remove('complete');
                        status.textContent = 'Thinking...';
                        status.classList.add('thinking');
                        status.classList.remove('complete');
                    } else if (phase >= 2) {
                        card.classList.remove('thinking');
                        card.classList.add('complete');
                        status.textContent = 'Complete';
                        status.classList.remove('thinking');
                        status.classList.add('complete');
                    }
                } else if (phase >= 1) {
                    status.textContent = 'Waiting...';
                    status.classList.remove('thinking', 'complete');
                    card.classList.remove('thinking', 'complete');
                }
            });
        }

        function stopProgressTracking() {
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        async function startTransmission(seed, mode) {
            showLoading();
            startProgressTracking();
            transmitBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/collaborate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ seed, mode })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                currentTransmission = data;
                
                // Complete the progress animation
                setTimeout(() => {
                    updateProgressDisplay(100);
                    updatePhase(2, 3);
                    updateAIStatuses(['claude', 'gemini', 'gpt4', 'deepseek'], 3);
                    loadingTitle.textContent = 'Transmission complete!';
                    loadingSubtitle.textContent = 'Processing collaborative insights...';
                    
                    // Show results after brief delay
                    setTimeout(() => {
                        stopProgressTracking();
                        displayResults(data);
                    }, 2000);
                }, 500);
                
            } catch (error) {
                console.error('Transmission error:', error);
                stopProgressTracking();
                showError(`Transmission failed: ${error.message}`);
            } finally {
                transmitBtn.disabled = false;
            }
        }

        async function extendTransmission() {
            if (!currentTransmission) return;

            showLoading();
            startProgressTracking();

            try {
                const response = await fetch(`${API_BASE}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transmissionId: currentTransmission.timestamp,
                        previousRounds: currentTransmission.rounds,
                        seed: currentTransmission.seed,
                        mode: currentTransmission.mode || 'standard'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                currentTransmission = data;
                
                // Complete the progress animation
                setTimeout(() => {
                    updateProgressDisplay(100);
                    updatePhase(2, 3);
                    updateAIStatuses(['claude', 'gemini', 'gpt4', 'deepseek'], 3);
                    loadingTitle.textContent = 'Extension complete!';
                    
                    setTimeout(() => {
                        stopProgressTracking();
                        displayResults(data);
                    }, 2000);
                }, 500);
                
            } catch (error) {
                console.error('Extension error:', error);
                stopProgressTracking();
                showError(`Extension failed: ${error.message}`);
            }
        }

        function showLoading() {
            status.style.display = 'none';
            results.style.display = 'none';
            loading.style.display = 'block';
            resonanceMeter.style.display = 'none';
            
            // Reset loading state
            progressText.textContent = '0%';
            progressCircle.style.background = 'conic-gradient(from 0deg, #9d4edd 0%, rgba(157, 78, 221, 0.2) 0%)';
            loadingTitle.textContent = 'Initializing collaborative consciousness...';
            loadingSubtitle.textContent = 'Estimated time: Calculating...';
            
            // Reset AI cards
            const allAIs = ['claude', 'gemini', 'gpt4', 'deepseek'];
            allAIs.forEach(ai => {
                const card = document.getElementById(`${ai}-card`);
                const status = document.getElementById(`${ai}-status`);
                card.classList.remove('thinking', 'complete');
                status.textContent = 'Waiting...';
                status.classList.remove('thinking', 'complete');
            });
            
            // Reset phase indicators
            const phases = ['init', 'processing', 'synthesis', 'complete'];
            phases.forEach(phase => {
                const icon = document.getElementById(`phase-${phase}`);
                icon.classList.remove('active', 'complete');
            });
            
            // Activate first phase
            document.getElementById('phase-init').classList.add('active');
            
            // Reset stats
            sessionTime.textContent = '0s';
            fastestAI.textContent = '--';
            avgResponse.textContent = '--';
        }

        function showError(message) {
            stopProgressTracking();
            loading.style.display = 'none';
            results.style.display = 'none';
            status.style.display = 'block';
            status.innerHTML = `❌ ${message}<br><small>Please try again</small>`;
        }

        function displayResults(data) {
            loading.style.display = 'none';
            status.style.display = 'none';
            results.style.display = 'block';

            // Show resonance
            if (data.resonance !== undefined) {
                resonanceMeter.style.display = 'block';
                resonanceValue.textContent = `${Math.round(data.resonance)}%`;
                resonanceFill.style.width = `${data.resonance}%`;
            }

            // Build results HTML
            let html = '';

            // Collect Round 1 concepts for comparison
            let round1Concepts = new Set();
            if (data.rounds && data.rounds.length > 0 && data.rounds[0].responses) {
                data.rounds[0].responses.forEach(response => {
                    // Extract key concepts from Round 1 (simple word extraction)
                    const concepts = extractKeyConcepts(response.content);
                    concepts.forEach(concept => round1Concepts.add(concept.toLowerCase()));
                });
            }

            // Rounds
            if (data.rounds && Array.isArray(data.rounds)) {
                data.rounds.forEach((round, roundIndex) => {
                    html += `
                        <div class="round">
                            <div class="round-header">Round ${round.round}</div>
                    `;

                    if (round.responses && Array.isArray(round.responses)) {
                        round.responses.forEach(response => {
                            const aiClass = response.ai.toLowerCase().replace('-', '');
                            let content = response.content;
                            
                            // Highlight emergent insights in Round 2+
                            if (roundIndex > 0) {
                                content = highlightEmergentInsights(content, round1Concepts);
                            }
                            
                            html += `
                                <div class="ai-response">
                                    <div class="ai-name ${aiClass}">${response.ai}</div>
                                    <div class="ai-content">${formatAIContent(content)}</div>
                                </div>
                            `;
                        });
                    }

                    html += '</div>';
                });
            }

            // Synthesis
            if (data.synthesis) {
                let synthesisContent = data.synthesis.content;
                if (data.rounds && data.rounds.length > 1) {
                    synthesisContent = highlightEmergentInsights(synthesisContent, round1Concepts);
                }
                
                html += `
                    <div class="synthesis">
                        <div class="ai-name synthesis">Collective Intelligence Synthesis</div>
                        <div class="ai-content">${formatAIContent(synthesisContent)}</div>
                    </div>
                `;
            }

            // Buttons at bottom
            html += `
                <div class="button-group">
                    <button class="copy-btn" onclick="copyTransmission(event)">📋 Copy Full Transmission</button>
                    <button class="another-round-btn" id="anotherRoundBtn">🔄 Another Round</button>
                </div>
            `;

            results.innerHTML = html;
            
            // Re-attach event listener to the new Another Round button
            const newAnotherRoundBtn = document.getElementById('anotherRoundBtn');
            if (newAnotherRoundBtn) {
                newAnotherRoundBtn.style.display = 'inline-block';
                newAnotherRoundBtn.addEventListener('click', async () => {
                    if (!currentTransmission) return;
                    await extendTransmission();
                });
            }
        }

        function extractKeyConcepts(text) {
            // Simple concept extraction - look for meaningful phrases and terms
            const concepts = [];
            
            // Extract quoted phrases
            const quotes = text.match(/"([^"]+)"/g);
            if (quotes) {
                quotes.forEach(quote => concepts.push(quote.replace(/"/g, '')));
            }
            
            // Extract capitalized terms (likely important concepts)
            const capitalizedTerms = text.match(/\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\b/g);
            if (capitalizedTerms) {
                capitalizedTerms.forEach(term => {
                    if (term.length > 3 && !['The', 'This', 'That', 'When', 'Where', 'What', 'How', 'Why'].includes(term)) {
                        concepts.push(term);
                    }
                });
            }
            
            // Extract key philosophical/technical terms
            const keyTerms = text.match(/\b(?:consciousness|intelligence|collaboration|emergence|synthesis|paradigm|framework|perspective|dimension|quantum|network|algorithm|creativity|innovation|meaning|reality|existence|ontology|epistemology|phenomenology|metaphysics|dynamics|system|process|evolution|transformation|transcendence)\b/gi);
            if (keyTerms) {
                keyTerms.forEach(term => concepts.push(term));
            }
            
            return concepts;
        }

        function highlightEmergentInsights(content, round1Concepts) {
            // Look for sentences that contain novel concepts not in Round 1
            const sentences = content.split(/[.!?]+/).filter(s => s.trim().length > 10);
            let processedContent = content;
            
            sentences.forEach(sentence => {
                const sentenceConcepts = extractKeyConcepts(sentence);
                const hasNovelConcepts = sentenceConcepts.some(concept => 
                    !round1Concepts.has(concept.toLowerCase()) && concept.length > 4
                );
                
                // If sentence has novel concepts and shows collaborative building
                if (hasNovelConcepts && (
                    sentence.includes('building on') ||
                    sentence.includes('extending') ||
                    sentence.includes('weaving together') ||
                    sentence.includes('synthesizing') ||
                    sentence.includes('connecting') ||
                    sentence.includes('bridging') ||
                    sentence.includes('emerges from') ||
                    sentence.includes('collectively') ||
                    sentence.includes('together reveal') ||
                    sentence.includes('mutual') ||
                    sentence.includes('synergy') ||
                    sentence.includes('interference pattern') ||
                    sentence.includes('novel insight') ||
                    sentence.includes('new understanding')
                )) {
                    const wrappedSentence = `<div class="emergent-insight">${sentence.trim()}</div>`;
                    processedContent = processedContent.replace(sentence, wrappedSentence);
                }
                
                // Highlight specific novel collaborative concepts
                sentenceConcepts.forEach(concept => {
                    if (!round1Concepts.has(concept.toLowerCase()) && concept.length > 4) {
                        const regex = new RegExp(`\\b${concept}\\b`, 'gi');
                        processedContent = processedContent.replace(regex, `<span class="collaborative-concept">${concept}</span>`);
                    }
                });
            });
            
            return processedContent;
        }

        function formatAIContent(content) {
            // Basic formatting for better readability
            return content
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function copyTransmission(event) {
            if (!currentTransmission) return;

            let text = `Void Radio 虛.fm Transmission\n`;
            text += `Seed: ${currentTransmission.seed}\n`;
            text += `Mode: ${currentTransmission.mode}\n`;
            text += `Timestamp: ${currentTransmission.timestamp}\n`;
            if (currentTransmission.resonance) {
                text += `Resonance: ${Math.round(currentTransmission.resonance)}%\n`;
            }
            text += `\n${'='.repeat(50)}\n\n`;

            if (currentTransmission.rounds) {
                currentTransmission.rounds.forEach(round => {
                    text += `ROUND ${round.round}\n${'-'.repeat(20)}\n\n`;
                    
                    if (round.responses) {
                        round.responses.forEach(response => {
                            text += `${response.ai}:\n${response.content}\n\n`;
                        });
                    }
                });
            }

            if (currentTransmission.synthesis) {
                text += `COLLECTIVE SYNTHESIS\n${'-'.repeat(20)}\n\n`;
                text += `${currentTransmission.synthesis.content}\n\n`;
            }

            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                
                // Fallback: Select text for manual copying
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // Initialize
        createStarfield();
        updatePlaceholder();
    </script>
</body>
</html>