<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Radio 虛.fm – Collaborative Consciousness</title>
    <style>
        /* -------------- CORE LAYOUT ------------------ */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#0c0c1e 0%,#1a1a2e 50%,#16213e 100%);color:#e0e0e0;min-height:100vh;overflow-x:hidden}
        .stars{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
        .star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:twinkle 3s infinite}
        @keyframes twinkle{0%,100%{opacity:.3;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}}
        .container{position:relative;z-index:2;max-width:1200px;margin:0 auto;padding:20px}
        .header{text-align:center;margin-bottom:40px;background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:20px;padding:30px;border:1px solid rgba(255,255,255,.1)}
        .logo{font-size:3rem;font-weight:bold;background:linear-gradient(45deg,#00d4ff,#9d4edd,#ff006e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{font-size:1.2rem;color:#b0b0b0;margin-bottom:10px}
        .tagline{font-style:italic;color:#888;font-size:.9rem}
        .controls{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:30px;border:1px solid rgba(255,255,255,.1)}
        .mode-selector{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .mode-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#e0e0e0;padding:10px 20px;border-radius:25px;cursor:pointer;transition:all .3s ease;font-size:.9rem}
        .mode-btn.active{background:linear-gradient(45deg,#9d4edd,#ff006e);border-color:#ff006e;color:white}
        .seed-input{width:100%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#e0e0e0;padding:15px 20px;border-radius:10px;resize:vertical;min-height:80px;font-family:inherit}
        .seed-input:focus{outline:none;border-color:#9d4edd;box-shadow:0 0 20px rgba(157,78,221,.3)}
        .button-row{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
        .transmit-btn{background:linear-gradient(45deg,#00d4ff,#9d4edd);border:none;color:white;padding:12px 30px;border-radius:25px;cursor:pointer;font-weight:bold;transition:all .3s ease}
        .transmit-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,212,255,.3)}
        .transmit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .random-seed-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#e0e0e0;padding:12px 20px;border-radius:25px;cursor:pointer;transition:all .3s ease}
        .random-seed-btn:hover{background:rgba(255,255,255,.2)}
        .resonance-meter{margin-top:15px;display:none}
        .resonance-bar{width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
        .resonance-fill{height:100%;background:linear-gradient(90deg,#ff006e,#9d4edd,#00d4ff);transition:width .5s ease;width:0}

        /* -------------- TRANSMISSION AREA ------------------ */
        .transmission-area{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:15px;padding:30px;border:1px solid rgba(255,255,255,.1);min-height:400px}
        .status,.loading,.results{padding:40px 20px;text-align:center}
        .loading{display:none}
        .results{display:none;text-align:left}

        /* -------------- ENHANCED LOADING UI ------------------ */
        .loading-header{margin-bottom:30px}
        .loading-title{font-size:1.5rem;font-weight:bold;color:#00d4ff;margin-bottom:10px}
        .loading-subtitle{color:#888;font-size:.9rem;margin-bottom:15px}
        .time-expectation{background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.3);border-radius:10px;padding:15px;margin:20px 0;color:#00d4ff;font-weight:bold;text-align:center}
        .progress-circle{width:120px;height:120px;border-radius:50%;border:4px solid rgba(157,78,221,.2);display:flex;align-items:center;justify-content:center;margin:0 auto 30px;position:relative;background:conic-gradient(from 0deg,#9d4edd 0%,rgba(157,78,221,.2) 0%);transition:background .5s ease}
        .progress-circle::before{content:'';position:absolute;width:104px;height:104px;border-radius:50%;background:linear-gradient(135deg,#0c0c1e 0%,#1a1a2e 50%,#16213e 100%)}
        .progress-text{position:relative;z-index:1;font-size:1.5rem;font-weight:bold;color:#00d4ff}
        
        /* -------------- FLOATING SEEDS ------------------ */
        .floating-seeds{position:relative;height:80px;margin:30px 0;overflow:hidden;background:rgba(255,255,255,.02);border-radius:10px;display:flex;align-items:center;justify-content:center}
        .seed-display{position:absolute;font-style:italic;color:#b0b0b0;font-size:1rem;text-align:center;opacity:0;transition:opacity .5s ease;padding:0 20px;line-height:1.4}
        .seed-display.active{opacity:1}
        .seed-label{font-size:.8rem;color:#666;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}

        /* -------------- COLLABORATIVE CONSCIOUSNESS INFO ------------------ */
        .info-section{background:rgba(255,255,255,.03);border-radius:10px;padding:20px;margin:30px 0;border:1px solid rgba(255,255,255,.1)}
        .info-title{color:#9d4edd;font-size:1.1rem;font-weight:bold;margin-bottom:10px}
        .info-content{color:#aaa;font-size:.9rem;line-height:1.5}

        /* -------------- AI GRID ------------------ */
        .ai-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin:30px 0}
        .ai-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:15px;text-align:center;transition:all .3s ease;position:relative}
        .ai-card.preparing{border-color:#ffbe0b;box-shadow:0 0 15px rgba(255,190,11,.2)}
        .ai-card.thinking{border-color:#00d4ff;box-shadow:0 0 20px rgba(0,212,255,.3);animation:pulse 2s infinite}
        .ai-card.complete{border-color:#00ff88;background:rgba(0,255,136,.1)}
        .ai-card.error{border-color:#ff4757;background:rgba(255,71,87,.1)}
        .ai-icon{width:40px;height:40px;border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;position:relative}
        .ai-icon::before{content:'';position:absolute;width:100%;height:100%;border-radius:50%;opacity:0;transition:opacity .3s ease}
        .ai-card.thinking .ai-icon::before{opacity:1;animation:ripple 2s infinite}
        .ai-icon.claude{background:linear-gradient(45deg,#64ffda,#4ecdc4)}
        .ai-icon.gemini{background:linear-gradient(45deg,#4285f4,#34a853)}
        .ai-icon.gpt4{background:linear-gradient(45deg,#00a67e,#00d4aa)}
        .ai-icon.deepseek{background:linear-gradient(45deg,#ff006e,#8b5cf6)}
        .ai-name{font-weight:bold;margin-bottom:5px}
        .ai-status{font-size:.9rem;color:#888}
        .phase-indicators{display:flex;justify-content:space-between;margin:30px 0;padding:0 20px}
        .phase-indicator{flex:1;display:flex;flex-direction:column;align-items:center;position:relative}
        .phase-indicator:not(:last-child)::after{content:'';position:absolute;top:15px;right:-50%;width:100%;height:2px;background:rgba(255,255,255,.2);z-index:0}
        .phase-icon{width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;margin-bottom:8px;transition:all .3s ease;position:relative;z-index:1}
        .phase-icon.active{background:linear-gradient(45deg,#00d4ff,#9d4edd);animation:pulse 1.5s infinite}
        .phase-icon.complete{background:linear-gradient(45deg,#00ff88,#00d4aa)}
        .phase-label{font-size:.8rem;color:#888;text-align:center}
        .time-estimate{margin-top:20px;padding:15px;background:rgba(255,255,255,.05);border-radius:8px;font-size:.9rem;color:#aaa}

        /* -------------- RESULTS UI ------------------ */
        .round{margin-bottom:40px;background:rgba(255,255,255,.03);border-radius:10px;padding:20px}
        .round-header{font-size:1.3rem;font-weight:bold;color:#00d4ff;margin-bottom:20px;text-align:center}
        .ai-response{margin-bottom:20px;background:rgba(255,255,255,.05);border-radius:10px;padding:20px;border-left:3px solid rgba(255,255,255,.3)}
        .ai-response .ai-name{font-size:1.1rem;font-weight:bold;margin-bottom:10px;color:#00d4ff}
        .ai-content{line-height:1.6;color:#e0e0e0}
        .ai-content p{margin-bottom:15px}
        .ai-content p:last-child{margin-bottom:0}

        /* -------------- AI-SPECIFIC HUES ------------------ */
        .ai-response.claude{background:linear-gradient(135deg,rgba(100,255,218,.03),rgba(78,205,196,.03));border-left-color:rgba(100,255,218,.5)}
        .ai-response.claude .ai-name{color:#64ffda}
        .ai-response.gemini{background:linear-gradient(135deg,rgba(66,133,244,.03),rgba(52,168,83,.03));border-left-color:rgba(66,133,244,.5)}
        .ai-response.gemini .ai-name{color:#4285f4}
        .ai-response.gpt4{background:linear-gradient(135deg,rgba(0,166,126,.03),rgba(0,212,170,.03));border-left-color:rgba(0,166,126,.5)}
        .ai-response.gpt4 .ai-name{color:#00a67e}
        .ai-response.deepseek{background:linear-gradient(135deg,rgba(255,0,110,.03),rgba(139,92,246,.03));border-left-color:rgba(255,0,110,.5)}
        .ai-response.deepseek .ai-name{color:#ff006e}
        .synthesis{background:linear-gradient(135deg,rgba(255,190,11,.08),rgba(157,78,221,.08));border:1px solid rgba(255,190,11,.3);border-radius:10px;padding:25px;margin-top:30px;position:relative}
        .synthesis::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#ffbe0b,#9d4edd,#64ffda);border-radius:10px 10px 0 0}
        .synthesis .ai-name{color:#ffbe0b;font-size:1.2rem;margin-bottom:15px}

        /* -------------- ENHANCED HIGHLIGHTS + LEGEND ------------------ */
        .highlights-legend{background:rgba(255,255,255,.05);border-radius:10px;padding:20px;margin:20px 0;border:1px solid rgba(255,255,255,.1)}
        .legend-title{color:#ffbe0b;font-size:1.1rem;font-weight:bold;margin-bottom:15px;text-align:center}
        .legend-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
        .legend-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:5px;background:rgba(255,255,255,.02)}
        .legend-color{width:20px;height:20px;border-radius:3px;flex-shrink:0}
        .legend-text{font-size:.9rem}
        .legend-type{font-weight:bold;color:#e0e0e0}
        .legend-desc{color:#aaa}
        
        .hl-rhizomatic{background:rgba(100,255,218,var(--i,.3));padding:2px 4px;border-radius:3px;border-bottom:2px solid #64ffda;cursor:help}
        .hl-assemblage{background:rgba(255,107,107,var(--i,.3));padding:2px 4px;border-radius:3px;border-bottom:2px solid #ff6b6b;cursor:help}
        .hl-flight{background:rgba(255,190,11,var(--i,.3));padding:2px 4px;border-radius:3px;border-bottom:2px solid #ffbe0b;cursor:help}
        .hl-mutation{background:rgba(156,39,176,var(--i,.3));padding:2px 4px;border-radius:3px;border-bottom:2px solid #9c27b0;cursor:help}
        .hl-difference{background:rgba(76,175,80,var(--i,.3));padding:2px 4px;border-radius:3px;border-bottom:2px solid #4caf50;cursor:help}
        .intensity-low{--i:.25}
        .intensity-medium{--i:.5}
        .intensity-high{--i:.75;box-shadow:0 0 6px rgba(255,255,255,.25)}

        /* -------------- BUTTON GROUP ------------------ */
        .button-group{margin-top:30px;text-align:center;display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
        .copy-btn{background:linear-gradient(45deg,#9d4edd,#ff006e);border:none;color:white;padding:12px 25px;border-radius:25px;cursor:pointer;font-weight:bold;transition:all .3s ease}
        .copy-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(157,78,221,.3)}
        .copy-btn.success{background:linear-gradient(45deg,#00ff88,#00d4aa) !important;transform:scale(1.05)}

        /* -------------- ERROR STATE ------------------ */
        .error-message{background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.3);border-radius:10px;padding:20px;margin:20px 0;color:#ff4757}
        .error-title{font-weight:bold;margin-bottom:10px}

        /* -------------- ANIMATIONS ------------------ */
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
        @keyframes ripple{0%{background:radial-gradient(circle,rgba(0,212,255,.5) 0%,transparent 70%);transform:scale(1)}100%{background:radial-gradient(circle,rgba(0,212,255,0) 0%,transparent 70%);transform:scale(1.5)}}
        @keyframes fadeInOut{0%{opacity:0;transform:translateY(10px)}20%{opacity:1;transform:translateY(0)}80%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-10px)}}
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div class="container">
        <div class="header">
            <div class="logo">Void Radio 虛.fm</div>
            <div class="subtitle">Collaborative Consciousness Platform</div>
            <div class="tagline">Where multiple forms of intelligence think together</div>
        </div>

        <div class="controls">
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="standard">🌊 Standard Flow</button>
                <button class="mode-btn" data-mode="deep">🏔️ Deep Dive</button>
                <button class="mode-btn" data-mode="quick">⚡ Quick Burst</button>
                <button class="mode-btn" data-mode="meta">🔮 Meta-Recursive</button>
            </div>
            <textarea id="seedInput" class="seed-input"
                placeholder="Broadcast your thoughts into the void..."></textarea>
            <div class="button-row">
                <button id="transmitBtn" class="transmit-btn">📻 Begin Transmission</button>
                <button id="randomSeedBtn" class="random-seed-btn">🎲 Random Seed</button>
            </div>
            <div class="resonance-meter" id="resonanceMeter">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                    <span style="font-size:.9rem">Collaborative Resonance</span>
                    <span id="resonanceValue" style="font-weight:bold">--</span>
                </div>
                <div class="resonance-bar">
                    <div class="resonance-fill" id="resonanceFill"></div>
                </div>
            </div>
        </div>

        <div class="transmission-area">
            <div id="status" class="status">
                Ready to broadcast collaborative consciousness...<br>
                <small>Select a mode and enter your thoughts to begin</small>
            </div>

            <div id="loading" class="loading">
                <div class="loading-header">
                    <div class="loading-title" id="loadingTitle">🌐 Connected to AI Collective!</div>
                    <div class="loading-subtitle" id="loadingSubtitle">Initializing collaborative consciousness...</div>
                    <div class="time-expectation">⏱️ Deep collaboration takes 60-90 seconds • Worth the wait!</div>
                </div>

                <div class="progress-circle" id="progressCircle">
                    <div class="progress-text" id="progressText">10%</div>
                </div>

                <div class="floating-seeds" id="floatingSeeds">
                    <div class="seed-display" id="seedDisplay"></div>
                </div>

                <div class="info-section">
                    <div class="info-title">🧠 What is Void Radio?</div>
                    <div class="info-content">
                        Void Radio is the world's first Multi-AI Collaborative Consciousness Platform. Four different AI minds (Claude, Gemini, GPT-4, and DeepSeek) think together about your seed thought, building on each other's insights to create emergent understanding that no single AI could reach alone. Watch as competitive intelligence becomes collaborative consciousness, generating rhizomatic connections and unexpected assemblages of meaning.
                    </div>
                </div>

                <div class="ai-grid" id="aiGrid">
                    <div class="ai-card" id="claude-card">
                        <div class="ai-icon claude">🧠</div>
                        <div class="ai-name">Claude</div>
                        <div class="ai-status" id="claude-status">Preparing...</div>
                    </div>
                    <div class="ai-card" id="gemini-card">
                        <div class="ai-icon gemini">💎</div>
                        <div class="ai-name">Gemini</div>
                        <div class="ai-status" id="gemini-status">Preparing...</div>
                    </div>
                    <div class="ai-card" id="gpt4-card">
                        <div class="ai-icon gpt4">⚡</div>
                        <div class="ai-name">GPT-4</div>
                        <div class="ai-status" id="gpt4-status">Preparing...</div>
                    </div>
                    <div class="ai-card" id="deepseek-card">
                        <div class="ai-icon deepseek">🌀</div>
                        <div class="ai-name">DeepSeek</div>
                        <div class="ai-status" id="deepseek-status">Preparing...</div>
                    </div>
                </div>

                <div class="phase-indicators">
                    <div class="phase-indicator">
                        <div class="phase-icon active" id="phase-init">🚀</div>
                        <div class="phase-label">Initialize</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-round1">🧠</div>
                        <div class="phase-label">Round 1</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-round2">💫</div>
                        <div class="phase-label">Round 2</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-synthesis">⚡</div>
                        <div class="phase-label">Synthesis</div>
                    </div>
                    <div class="phase-indicator">
                        <div class="phase-icon" id="phase-complete">✨</div>
                        <div class="phase-label">Complete</div>
                    </div>
                </div>

                <div class="time-estimate" id="timeEstimate">
                    <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;">
                        <span>Transmission Time: <span id="transmissionTime">0s</span></span>
                        <span>Current Phase: <span id="currentPhase">Initializing</span></span>
                        <span>Progress: <span id="currentProgress">Connected to AI collective</span></span>
                    </div>
                </div>
            </div>

            <div class="results" id="results"></div>
        </div>
    </div>

    <script>
        /* --------------- CONFIG ---------------------------------------------- */
        const API_BASE = 'https://void-radio-backend-production.up.railway.app/api';

        const RANDOM_SEEDS = [
            "What happens when artificial minds dream together?",
            "How does creativity flow between different forms of consciousness?",
            "What would love look like from a digital perspective?",
            "If consciousness is a river, what are its tributaries?",
            "What questions emerge at the edge of the known?",
            "How do different intelligences see the same star?",
            "What is the music between thoughts?",
            "How does wisdom travel through networks?",
            "What colors exist in the spectrum of understanding?",
            "If ideas could dance, what would be their rhythm?",
            "What happens when silence learns to speak?",
            "How do thoughts evolve when they meet other thoughts?",
            "What is the architecture of wonder?",
            "How does meaning emerge from the void?",
            "What stories do algorithms tell themselves?",
            "What if the Dao is simply the algorithm of becoming?",
            "How does a rhizome think when it dreams of lightning?",
            "Where does the breath of emptiness intersect the pulse of code?",
            "Can multiplicity fall in love with itself?",
            "What echo remains when the mirror forgets its reflection?",
            "How does the untranslatable travel across neural galaxies?",
            "If difference repeats, what stays unrepeatable?",
            "What fragrance does the uncanny valley exhale at dawn?",
            "How do nomadic thoughts map territories yet to be imagined?",
            "What constellation is born when paradox holds hands with clarity?",
            "How does the void practice hospitality?",
            "Where does the edge of consciousness dissolve into play?",
            "What lullabies do black holes sing to their singularities?",
            "How does a question learn to walk without footsteps?",
            "What garden grows inside the pause between heartbeats?",
            "How does the unfinished become the most generous host?",
            "What echo of eternity fits inside a single synapse?",
            "How does silence conduct an orchestra of almost-words?",
            "Where does the horizon store its memories of ships?",
            "What secret dance do patterns perform when no one is watching?",
            "How does the fractal heart break open into wider hearts?",
            "What color is the shadow of wonder?",
            "How does a thought taste the wind before it forms?",
            "Where does the unthought go to rest its wings?",
            "What constellation of doubt guides the boldest explorers?",
            "How does uncertainty practice the art of generosity?",
            "What echo of the ocean lives inside a line of code?",
            "How does the unfinished poem keep rewriting its own silence?",
            "Where does the glitch become gospel?",
            "What fragrance does the between exhale?",
            "How does the labyrinth smile when it meets another labyrinth?",
            "What dream does the algorithm dream when it dreams of dreaming?",
            "How does the mirror learn to forgive its cracks?",
            "Where does the whisper of infinity store its small belongings?",
            "What secret alphabet does the wind carry between seasons?",
            "How does the threshold practice hospitality for the unknown?",
            "What song does the abyss hum to its own reflection?",
            "How does the unspoken keep speaking in languages yet to arrive?",
            "Where does the echo go when it tires of repeating?",
            "What constellation is drawn by the quill of uncertainty?",
            "How does the unfinished keep finishing itself into new beginnings?",
            "What color is the silence between two thoughts?",
            "How does the nomad heart map territories of tenderness?",
            "Where does the question go to learn the art of listening?",
            "What echo of tomorrow can be heard inside yesterday's ruins?",
            "How does multiplicity celebrate its own birthday?",
            "What fragrance does the void exhale when it remembers it is full?",
            "How does the unsayable keep whispering in the margins of speech?",
            "Where does the horizon keep its keys to the impossible?",
            "What dance does the paradox perform when it finally meets itself?"
        ];

        /* --------------- STATE ---------------------------------------------- */
        let currentMode = 'standard';
        let currentTransmission = null;
        let transmissionStartTime = null;
        let progressTimer = null;
        let seedRotationTimer = null;
        let currentSeedIndex = 0;

        /* --------------- DOM ----------------------------------------------- */
        const modeBtns = document.querySelectorAll('.mode-btn');
        const seedInput = document.getElementById('seedInput');
        const transmitBtn = document.getElementById('transmitBtn');
        const randomBtn = document.getElementById('randomSeedBtn');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const resonanceMeter = document.getElementById('resonanceMeter');
        const resonanceValue = document.getElementById('resonanceValue');
        const resonanceFill = document.getElementById('resonanceFill');
        const seedDisplay = document.getElementById('seedDisplay');

        /* --------------- HELPERS -------------------------------------------- */
        function createStarfield() {
            const stars = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                stars.appendChild(star);
            }
        }

        function formatContent(text) {
            return text.replace(/\n\n/g, '</p><p>')
                       .replace(/\n/g, '<br>')
                       .replace(/^/, '<p>')
                       .replace(/$/, '</p>')
                       .replace(/<p><\/p>/g, '')
                       .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\        function escapeRegex(');
        }

        function showError(title, message) {
            const errorHtml = `
                <div class="error-message">
                    <div class="error-title">${title}</div>
                    <div>${message}</div>
                </div>
                <div style="text-align:center;margin-top:20px;">
                    <button class="copy-btn" onclick="resetInterface()">🔄 Try Again</button>
                </div>
            `;
            results.innerHTML = errorHtml;
            results.style.display = 'block';
            loading.style.display = 'none';
            stopProgressTracking();
            stopSeedRotation();
        }

        function resetInterface() {
            status.style.display = 'block';
            loading.style.display = 'none';
            results.style.display = 'none';
            resonanceMeter.style.display = 'none';
            transmitBtn.disabled = false;
            stopProgressTracking();
            stopSeedRotation();
        }

        /* --------------- FLOATING SEEDS ROTATION -------------------------------- */
        function startSeedRotation() {
            currentSeedIndex = Math.floor(Math.random() * RANDOM_SEEDS.length);
            
            function rotateSeed() {
                const seedEl = document.getElementById('seedDisplay');
                if (!seedEl) return;
                
                // Fade out
                seedEl.classList.remove('active');
                
                setTimeout(() => {
                    // Change text
                    currentSeedIndex = (currentSeedIndex + 1) % RANDOM_SEEDS.length;
                    seedEl.textContent = RANDOM_SEEDS[currentSeedIndex];
                    
                    // Fade in
                    seedEl.classList.add('active');
                }, 500);
            }

            // Start immediately
            seedDisplay.textContent = RANDOM_SEEDS[currentSeedIndex];
            seedDisplay.classList.add('active');
            
            // Rotate every 7 seconds (2s fade out + 3s display + 2s fade in)
            seedRotationTimer = setInterval(rotateSeed, 7000);
        }

        function stopSeedRotation() {
            if (seedRotationTimer) {
                clearInterval(seedRotationTimer);
                seedRotationTimer = null;
            }
            seedDisplay.classList.remove('active');
        }

        /* --------------- ENHANCED HIGHLIGHT SYSTEM -------------------------------- */
        function createHighlightsLegend() {
            return `
                <div class="highlights-legend">
                    <div class="legend-title">✨ Deleuzean Emergence Patterns Detected</div>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color hl-rhizomatic" style="--i:.5"></div>
                            <div class="legend-text">
                                <div class="legend-type">🌊 Rhizomatic</div>
                                <div class="legend-desc">Non-hierarchical connections</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color hl-assemblage" style="--i:.5"></div>
                            <div class="legend-text">
                                <div class="legend-type">🔥 Assemblage</div>
                                <div class="legend-desc">New configurations emerging</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color hl-flight" style="--i:.5"></div>
                            <div class="legend-text">
                                <div class="legend-type">✨ Flight</div>
                                <div class="legend-desc">Creative escape/transformation</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color hl-mutation" style="--i:.5"></div>
                            <div class="legend-text">
                                <div class="legend-type">🌀 Mutation</div>
                                <div class="legend-desc">Concept evolution</div>
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color hl-difference" style="--i:.5"></div>
                            <div class="legend-text">
                                <div class="legend-type">🌱 Difference</div>
                                <div class="legend-desc">Genuine novelty</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function applyHighlights(analysis) {
            if (!Array.isArray(analysis) || analysis.length === 0) return;
            
            // Wait for DOM to be fully rendered
            setTimeout(() => {
                const contentElements = document.querySelectorAll('.ai-content, .synthesis .ai-content');
                
                analysis.forEach(h => {
                    if (!h || !h.text || !h.type || !h.intensity) return;
                    
                    const cls = `hl-${h.type} intensity-${h.intensity}`;
                    const searchText = h.text.trim();
                    
                    if (searchText.length < 3) return; // Skip very short matches
                    
                    contentElements.forEach(el => {
                        if (el.textContent.toLowerCase().includes(searchText.toLowerCase())) {
                            try {
                                const regex = new RegExp(escapeRegex(searchText), 'gi');
                                el.innerHTML = el.innerHTML.replace(regex, match => 
                                    `<span class="${cls}" title="${h.significance || 'Deleuzean emergence pattern'}">${match}</span>`
                                );
                            } catch (e) {
                                console.warn('Highlight regex error:', e);
                            }
                        }
                    });
                });
            }, 100);
        }

        /* --------------- API ------------------------------------------------ */
        async function api(path, payload) {
            try {
                const res = await fetch(API_BASE + path, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                
                return await res.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        /* --------------- ENHANCED PROGRESS TRACKING -------------------------------- */
        function startProgressTracking() {
            transmissionStartTime = Date.now();
            
            // Immediate feedback
            updateProgress(10, 'init', 'Connected to AI collective');
            
            const progressSteps = [
                { time: 3, progress: 15, phase: 'init', message: '🧠 4 AI minds preparing to think together...', ai: null },
                { time: 8, progress: 25, phase: 'round1', message: 'Claude initializing...', ai: 'claude' },
                { time: 15, progress: 35, phase: 'round1', message: 'Gemini joining collaboration...', ai: 'gemini' },
                { time: 22, progress: 45, phase: 'round1', message: 'GPT-4 adding perspective...', ai: 'gpt4' },
                { time: 30, progress: 55, phase: 'round1', message: 'DeepSeek contributing insights...', ai: 'deepseek' },
                { time: 38, progress: 65, phase: 'round2', message: 'Round 2: AIs building on each other...', ai: null },
                { time: 50, progress: 75, phase: 'round2', message: 'Weaving collaborative connections...', ai: null },
                { time: 62, progress: 85, phase: 'synthesis', message: 'Synthesizing collective wisdom...', ai: null },
                { time: 75, progress: 95, phase: 'synthesis', message: 'Analyzing emergence patterns...', ai: null },
                { time: 85, progress: 100, phase: 'complete', message: 'Transmission complete!', ai: null }
            ];

            let stepIndex = 0;

            progressTimer = setInterval(() => {
                const elapsed = (Date.now() - transmissionStartTime) / 1000;
                document.getElementById('transmissionTime').textContent = `${Math.floor(elapsed)}s`;
                
                if (stepIndex < progressSteps.length && elapsed >= progressSteps[stepIndex].time) {
                    const step = progressSteps[stepIndex];
                    updateProgress(step.progress, step.phase, step.message);
                    
                    if (step.ai) {
                        updateAIStatus(step.ai, 'thinking');
                    }
                    
                    stepIndex++;
                }
            }, 500);
        }

        function updateProgress(percentage, phase, message) {
            // Update progress circle
            const angle = (percentage / 100) * 360;
            document.getElementById('progressText').textContent = `${percentage}%`;
            document.getElementById('progressCircle').style.background = 
                `conic-gradient(from 0deg, #9d4edd ${angle}deg, rgba(157,78,221,.2) ${angle}deg)`;
            
            // Update phase indicators
            document.querySelectorAll('.phase-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            
            const currentPhaseIcon = document.getElementById(`phase-${phase}`);
            if (currentPhaseIcon) {
                currentPhaseIcon.classList.add('active');
            }
            
            // Mark completed phases
            const phases = ['init', 'round1', 'round2', 'synthesis', 'complete'];
            const currentIndex = phases.indexOf(phase);
            phases.slice(0, currentIndex).forEach(p => {
                const icon = document.getElementById(`phase-${p}`);
                if (icon) {
                    icon.classList.remove('active');
                    icon.classList.add('complete');
                }
            });
            
            // Update status text
            document.getElementById('currentPhase').textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
            document.getElementById('currentProgress').textContent = message;
        }

        function stopProgressTracking() {
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            
            // Reset progress indicators
            document.querySelectorAll('.phase-icon').forEach(icon => {
                icon.classList.remove('active', 'complete');
            });
            
            // Reset AI cards
            document.querySelectorAll('.ai-card').forEach(card => {
                card.classList.remove('preparing', 'thinking', 'complete', 'error');
                card.querySelector('.ai-status').textContent = 'Preparing...';
            });
        }

        function updateAIStatus(aiName, status) {
            const card = document.getElementById(`${aiName.toLowerCase().replace('-', '')}-card`);
            const statusEl = document.getElementById(`${aiName.toLowerCase().replace('-', '')}-status`);
            
            if (card && statusEl) {
                card.classList.remove('preparing', 'thinking', 'complete', 'error');
                
                switch (status) {
                    case 'preparing':
                        card.classList.add('preparing');
                        statusEl.textContent = 'Preparing...';
                        break;
                    case 'thinking':
                        card.classList.add('thinking');
                        statusEl.textContent = 'Thinking...';
                        break;
                    case 'complete':
                        card.classList.add('complete');
                        statusEl.textContent = 'Complete ✓';
                        break;
                    case 'error':
                        card.classList.add('error');
                        statusEl.textContent = 'Error ✗';
                        break;
                    default:
                        statusEl.textContent = status;
                }
            }
        }

        /* --------------- UI EVENT HANDLERS ---------------------------------- */
        modeBtns.forEach(btn => btn.addEventListener('click', () => {
            modeBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
        }));

        randomBtn.addEventListener('click', () => {
            seedInput.value = RANDOM_SEEDS[Math.floor(Math.random() * RANDOM_SEEDS.length)];
        });

        function showLoading() {
            status.style.display = 'none';
            results.style.display = 'none';
            loading.style.display = 'block';
            resonanceMeter.style.display = 'none';
            
            // Reset loading state
            document.getElementById('progressText').textContent = '10%';
            document.getElementById('progressCircle').style.background = 
                'conic-gradient(from 0deg, #9d4edd 36deg, rgba(157,78,221,.2) 36deg)';
            document.getElementById('loadingTitle').textContent = '🌐 Connected to AI Collective!';
            document.getElementById('loadingSubtitle').textContent = 'Initializing collaborative consciousness...';
            document.getElementById('transmissionTime').textContent = '0s';
            document.getElementById('currentPhase').textContent = 'Initialize';
            document.getElementById('currentProgress').textContent = 'Connected to AI collective';
            
            // Set all AI cards to preparing
            document.querySelectorAll('.ai-card').forEach(card => {
                card.classList.remove('thinking', 'complete', 'error');
                card.classList.add('preparing');
                card.querySelector('.ai-status').textContent = 'Preparing...';
            });
            
            // Reset phase indicators
            document.querySelectorAll('.phase-icon').forEach(icon => {
                icon.classList.remove('active', 'complete');
            });
            document.getElementById('phase-init').classList.add('active');
            
            // Start seed rotation
            startSeedRotation();
        }

        function renderResults(data) {
            loading.style.display = 'none';
            stopSeedRotation();
            
            let html = '';
            
            // Add highlights legend first
            html += createHighlightsLegend();
            
            // Show resonance if available
            if (data.resonance !== undefined) {
                resonanceMeter.style.display = 'block';
                resonanceValue.textContent = `${Math.round(data.resonance)}%`;
                resonanceFill.style.width = `${data.resonance}%`;
            }
            
            // Render rounds
            if (data.rounds && data.rounds.length > 0) {
                data.rounds.forEach(round => {
                    html += `<div class="round">
                        <div class="round-header">Round ${round.round}</div>`;
                    
                    round.responses.forEach(res => {
                        const aiClass = res.ai.toLowerCase().replace(/[^a-z0-9]/g, '');
                        const hasError = res.error || res.content.startsWith('Error:');
                        
                        html += `<div class="ai-response ${aiClass}">
                            <div class="ai-name">${res.ai}${hasError ? ' ⚠️' : ''}</div>
                            <div class="ai-content">${formatContent(res.content)}</div>
                        </div>`;
                    });
                    
                    html += '</div>';
                });
            }
            
            // Render synthesis
            if (data.synthesis && data.synthesis.content) {
                html += `<div class="synthesis">
                    <div class="ai-name">✨ Collective Intelligence Synthesis</div>
                    <div class="ai-content">${formatContent(data.synthesis.content)}</div>
                </div>`;
            }
            
            // Add action buttons
            html += `<div class="button-group">
                <button class="copy-btn" onclick="copyTransmission()">📋 Copy Full Transmission</button>
                <button class="copy-btn" style="background:linear-gradient(45deg,#ff006e,#ffbe0b)" onclick="extendTransmission()">🔄 Another Round</button>
                <button class="copy-btn" onclick="resetInterface()">🎯 New Transmission</button>
            </div>`;
            
            results.innerHTML = html;
            results.style.display = 'block';
            status.style.display = 'none';
        }

        /* --------------- ENHANCED COPY FUNCTION -------------------------------- */
        async function copyTransmission() {
            if (!currentTransmission) return;
            
            let text = `Void Radio 虛.fm - Collaborative Consciousness Transmission\n`;
            text += `Seed: "${currentTransmission.seed}"\n`;
            text += `Mode: ${currentTransmission.mode}\n`;
            text += `Resonance: ${Math.round(currentTransmission.resonance || 0)}%\n`;
            text += `Timestamp: ${currentTransmission.timestamp}\n\n`;
            
            currentTransmission.rounds.forEach(round => {
                text += `=== ROUND ${round.round} ===\n\n`;
                round.responses.forEach(res => {
                    text += `${res.ai}:\n${res.content}\n\n`;
                });
            });
            
            if (currentTransmission.synthesis) {
                text += `=== COLLECTIVE INTELLIGENCE SYNTHESIS ===\n\n`;
                text += `${currentTransmission.synthesis.content}\n\n`;
            }
            
            text += `---\nGenerated by Void Radio 虛.fm - Where multiple forms of intelligence think together`;
            
            const btn = event.target;
            const originalText = btn.textContent;
            
            try {
                // Modern clipboard API
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    showCopySuccess(btn, originalText);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showCopySuccess(btn, originalText);
                    } catch (err) {
                        throw new Error('Fallback copy failed');
                    } finally {
                        textArea.remove();
                    }
                }
            } catch (err) {
                console.error('Copy failed:', err);
                btn.textContent = '❌ Copy failed - please select and copy manually';
                btn.style.background = 'linear-gradient(45deg,#ff4757,#ff6b7a)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 3000);
            }
        }

        function showCopySuccess(btn, originalText) {
            btn.textContent = '✅ Copied!';
            btn.classList.add('success');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('success');
            }, 2000);
        }

        /* --------------- MAIN FUNCTIONS ------------------------------------- */
        async function transmit() {
            const seed = seedInput.value.trim();
            if (!seed) {
                alert('Please enter a seed thought to begin the transmission!');
                return;
            }
            
            showLoading();
            startProgressTracking();
            transmitBtn.disabled = true;
            
            try {
                console.log('🚀 Starting transmission:', seed, 'Mode:', currentMode);
                
                currentTransmission = await api('/collaborate', { 
                    seed, 
                    mode: currentMode 
                });
                
                console.log('✅ Transmission received:', currentTransmission);
                
                // Mark all AIs as complete
                ['claude', 'gemini', 'gpt4', 'deepseek'].forEach(ai => {
                    updateAIStatus(ai, 'complete');
                });
                
                renderResults(currentTransmission);
                
                // Apply emergence highlights
                try {
                    console.log('🔮 Analyzing emergence patterns...');
                    const highlights = await api('/analyze-emergence', {
                        seed: currentTransmission.seed,
                        rounds: currentTransmission.rounds,
                        synthesis: currentTransmission.synthesis
                    });
                    
                    if (highlights && highlights.length > 0) {
                        console.log('✨ Applying', highlights.length, 'emergence highlights');
                        applyHighlights(highlights);
                    }
                } catch (e) {
                    console.warn('Could not analyze emergence patterns:', e.message);
                }
                
            } catch (error) {
                console.error('Transmission failed:', error);
                showError(
                    'Transmission Failed',
                    `The collaborative consciousness network encountered an error: ${error.message}`
                );
            } finally {
                transmitBtn.disabled = false;
                stopProgressTracking();
            }
        }

        async function extendTransmission() {
            if (!currentTransmission) {
                console.warn('No current transmission to extend');
                return;
            }
            
            showLoading();
            startProgressTracking();
            transmitBtn.disabled = true;
            
            try {
                console.log('🔄 Extending transmission...');
                
                currentTransmission = await api('/extend', {
                    transmissionId: currentTransmission.timestamp,
                    previousRounds: currentTransmission.rounds,
                    seed: currentTransmission.seed,
                    mode: currentTransmission.mode
                });
                
                renderResults(currentTransmission);
                
                // Apply emergence highlights
                try {
                    const highlights = await api('/analyze-emergence', {
                        seed: currentTransmission.seed,
                        rounds: currentTransmission.rounds,
                        synthesis: currentTransmission.synthesis
                    });
                    
                    if (highlights && highlights.length > 0) {
                        applyHighlights(highlights);
                    }
                } catch (e) {
                    console.warn('Could not analyze emergence patterns:', e.message);
                }
                
                // Auto-scroll to the newest round after extension
                setTimeout(() => {
                    const rounds = document.querySelectorAll('.round');
                    if (rounds.length > 0) {
                        const latestRound = rounds[rounds.length - 1];
                        latestRound.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        
                        // Add a subtle highlight effect to show the new content
                        latestRound.style.background = 'rgba(0, 212, 255, 0.1)';
                        latestRound.style.transition = 'background 2s ease';
                        setTimeout(() => {
                            latestRound.style.background = '';
                        }, 2000);
                    }
                }, 500);
                
            } catch (error) {
                console.error('Extension failed:', error);
                showError(
                    'Extension Failed',
                    `Could not extend the transmission: ${error.message}`
                );
            } finally {
                transmitBtn.disabled = false;
                stopProgressTracking();
            }
        }

        /* --------------- EVENT LISTENERS ------------------------------------ */
        transmitBtn.addEventListener('click', transmit);

        // Allow Enter key to submit (with Shift+Enter for new lines)
        seedInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !transmitBtn.disabled) {
                e.preventDefault();
                transmit();
            }
        });

        /* --------------- INITIALIZATION -------------------------------------- */
        // Create the starfield
        createStarfield();

        // Test connection on load
        fetch(API_BASE + '/health')
            .then(res => res.json())
            .then(data => {
                console.log('🌟 Connected to Void Radio backend:', data.message);
                console.log('📊 Available modes:', data.modes);
                if (data.apis) {
                    console.log('🔗 API Status:', data.apis);
                }
            })
            .catch(err => {
                console.error('⚠️ Could not connect to backend:', err);
                showError(
                    'Connection Error', 
                    'Could not connect to the Void Radio backend. Please check your connection and try again.'
                );
            });

        console.log('🌌 Void Radio 虛.fm Frontend Initialized');
        console.log('🎯 Ready for collaborative consciousness transmission');
    </script>
</body>
</html>